name: Pull Template Updates
permissions:
  contents: write
  pull-requests: write
on:
  schedule:
    - cron: "0 9 * * 1" # Every Monday at 9am
  workflow_dispatch:
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install cruft
        run: pip install cruft
      - name: Set SSH key for reading template repository
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.TEMPLATE_SSH_KEY }}
      - name: Check if update is available
        continue-on-error: false
        id: check
        run: |
          CHANGES=0
          if [ -f .cruft.json ]; then
            if ! cruft check; then
              CHANGES=1
            fi
          else
            echo "No .cruft.json file"
          fi

          echo "has_changes=$CHANGES" >> "$GITHUB_OUTPUT"
      - name: Run update if available
        if: steps.check.outputs.has_changes == '1'
        run: |
          cruft update --skip-apply-ask --refresh-private-variables
          git restore --staged .
      - name: Create pull request
        if: steps.check.outputs.has_changes == '1'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.WORKFLOW_TOKEN }}
          add-paths: .
          commit-message: "Pull template updates"
          branch: cruft/update
          delete-branch: true
          branch-suffix: timestamp
          title: Cruft - Sync with template updates
          body: |
            This is an autogenerated PR. Use this to merge the new template updates to this repository.

            **Do not merge this PR with .rej files.**
            .rej files are generated when there are conflicts between the template and the local files. You need to resolve them manually before merging.

            [Cruft](https://cruft.github.io/cruft/) has detected updates from the Cookiecutter template repository.